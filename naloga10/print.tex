\documentclass[a4paper,pdftex,10pt]{article}
\usepackage[margin=2.5cm,nohead]{geometry}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc} 
\usepackage[english,slovene]{babel} 
\usepackage{amsmath,amsfonts,amsthm,amssymb,mathrsfs,empheq} % Math packages
\usepackage{mathtools}
\usepackage{dsfont}
\usepackage{wrapfig}
\usepackage[pdftex]{graphicx}
%\usepackage{makeidx}
\usepackage{url}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{tabularx}
\usepackage{float}

\usepackage[version=3]{mhchem} %kemija

\DeclarePairedDelimiter{\evdel}{\langle}{\rangle}   %pricakovana vrednost


\renewcommand{\vec}[1]{\boldsymbol{\mathbf{#1}}}                                        
\newcommand{\ihat}[0]{\boldsymbol{\mathbf{\oldhat{\textbf{\i}}}}} % pokončna j in i (j i n i
\newcommand{\iu}{{i\mkern1mu}}	    %imaginarno število
\DeclarePairedDelimiterX{\norm}[1]{\lVert}{\rVert}{#1} %norma

\usepackage{fancyhdr} % Custom headers and footers
\pagestyle{fancyplain} % Makes all pages in the document conform to the custom headers and footers
\fancyhead{} % No page header - if you want one, create it in the same way as the footers below
\fancyfoot[L]{} % Empty left footer
\fancyfoot[C]{} % Empty center footer
\fancyfoot[R]{\thepage} % Page numbering for right footer
\renewcommand{\headrulewidth}{0pt} % Remove header underlines
\renewcommand{\footrulewidth}{0pt} % Remove footer underlines
\setlength{\headheight}{13.6pt} % Customize the height of the header

%\numberwithin{equation}{section} % Number equations within sections (i.e. 1.1, 1.2, 2.1, 2.2 instead of 1, 2, 3, 4)
\numberwithin{figure}{section} % Number figures within sections (i.e. 1.1, 1.2, 2.1, 2.2 instead of 1, 2, 3, 4)
%\numberwithin{table}{section} % Number tables within sections (i.e. 1.1, 1.2, 2.1, 2.2 instead of 1, 2, 3, 4)

\setlength\parindent{0pt} % Removes all indentation from paragraphs - comment this line for an assignment with lots of text

%----------------------------------------------------------------------------------------
%	TITLE SECTION
%----------------------------------------------------------------------------------------

\newcommand{\horrule}[1]{\rule{\linewidth}{#1}} % Create horizontal rule command with 1 argument of height

\title{	
\normalfont \normalsize 
\textsc{Modelska analiza 1} \\ [25pt] % Your university, school and/or department name(s)
%\horrule{0.2pt} \\[0.4cm] % Thin top horizontal rule
\huge 10. naloga - Spektralna analiza in filtriranje\\ % The assignment title
%\horrule{0.2pt} \\[0.5cm] % Thick bottom horizontal rule
}

\author{Tina Klobas} % Your name

\date{\normalsize\today} % Today's date or a custom date

\begin{document}

\maketitle % Print the title

\section{Opis problema}
Pri tej nalogi si bomo pogledali tri različne primere spektralne analize in filtriranja
podatkov. Z~diskretno Fourierovo transformacijo:
\begin{equation}
    F_k = \frac{1}{N} \sum_{j=0}^{N-1} f_j \mathrm{e}^{- 2\pi \mathrm{i} j k /N},
\end{equation}
vhodnega signala dobimo frekvenčni spekter, s~čimer dobimo informacijo o~fazah in amplitudah
signala. Moč spektra izračunamo kot:
\begin{equation}
    P_k = \frac{1}{2} ( | F_k |^2 + |F_{N-k}|^2 ). 
\end{equation}
V~prvem delu si bomo pogledali, kako razpon podatkov in izbira okenskih funkcij vpliva
na dobljen spekter. V~naslednjem odseku rekonstruirali vpadne signale iz dobljenih signalov,
iz katerih bomo z~Wienerjevim filtrom odstranili šum. Na koncu si bomo pogledali še 
rekonstrukcijo zašumljenih slik.

%----------------------------------------------------------------------------------------
%	PROBLEM 1
%----------------------------------------------------------------------------------------
\section{Določanje frekvenčnega spektra}
V~datotekah \path{val2.dat} in \path{val3.dat} imamo shranjena signala s~$512$ točkami in
jima želimo določiti frekvenčni spekter. Izhodni signal, je prikazan na grafu~\ref{slika1}. 
\begin{figure}[H] 
    \centering
    \resizebox{0.49\linewidth}{!}{\input{graf1a.tex}}
    \resizebox{0.49\linewidth}{!}{\input{graf1b.tex}}
    \caption{Vhodna signala -- na levi \protect\path{val2.dat} in na desni 
    \protect\path{val3.dat}.}
    \label{slika1}
\end{figure}

\subsection{Reševanje in rezultati}
Na sliki~\ref{slika2} sta prikazana spektra moči signalov v~logaritemski skali.
\begin{figure}[H]
    \centering
    \resizebox{0.8\linewidth}{!}{\input{graf2.tex}}
    \caption{Spektra signalov v~logaritemski skali.}
    \label{slika2}
\end{figure}
Fourierova transformacija deluje dobro za periodične funkcije -- v~našem primeru vidimo, da
ima dobljen graf za prvi spekter -- \emph{val2} -- dva izrazita vrha, kar kaže na 
periodičnost spektra, medtem ko so vsi štirje vrhovi drugega spektra -- \emph{val3} -- 
precej razširjeni, kar opozarja na nasprotno. \\
Najprej lahko preverimo, kaj se zgodi, če vzamemo krajše intervale točk; ${62,128,256}$. 
Naslednji graf~\ref{slika3} prikazuje spektre izračunane za štiri različne intervale točk. 
Za prvi spekter vidimo, da ima bolj ali manj enako obliko in širino vrhov -- razen za 
interval z~$64$ točkami, ki je bil očitno prekratek in smo izgubili informacije o~spektru. 
Za drugi spekter, pa vidimo, da se vrhovi zelo razširijo in spremenijo obliko -- sumimo, 
da že v~začetku nismo ujeli periodičnosti signala.\\
\begin{figure}[H]
    \centering
    \resizebox{0.49\linewidth}{!}{\input{graf3a.tex}}
    \resizebox{0.49\linewidth}{!}{\input{graf3b.tex}}
    \caption{Spektri moči (na levi \protect\path{val2} in na desni \protect\path{val3} za 
    različne intervale.}
    \label{slika3}
\end{figure}
Poskusimo obdelati signal še z~različnimi okenskimi funkcijami, ki signal na robu postavijo
na nič -- da dobimo periodičnost signala:
\begin{align}
     \text{Bartlett} &= 1 - \left| \frac{j-\frac{N}{2}}{\frac{N}{2}} \right|,
     & \text{Welch} &= 1- \left( \frac{j-\frac{N}{2}}{\frac{N}{2}} \right)^2,\\
     \text{Hann} &= \sin^2 \frac{\pi j}{N},
     & \text{eksponent} &= \mathrm{e}^{-|j-\frac{N}{2}|\frac{1}{\tau}},
\end{align}
kjer je $N$ število točk, za parameter $\tau$ pa bomo vzeli vrednost 
$\tau =\frac{N}{2}\frac{8.69}{60}.$ \\
\begin{figure}[H]
    \centering
    \resizebox{0.8\linewidth}{!}{\input{graf4.tex}}
    \caption{Različne okenske funkcije.}
    \label{slika4}
\end{figure}
Okenske funkcije pomnožimo s~signalom v~časovnem prostoru in naredimo Fourierovo 
transformacijo. Na naslednjem grafu~\ref{slika5} so podatki obdelani z~okenskimi funkcijami.
Vidimo, da z~okensko funkcijo na prvih podatkih (na sliki levo) spekter le poslabšamo --
predvsem z~eksponentnim oknom vidimo, da amplitudo precej zmanjšamo in razširimo vrhove.
Na drugem spektru (na desni) za eksponentno okno opazimo podobno -- znižali smo vrhove in
jih razširili. Od ostalih oken se je najbolje izkazala \emph{Hannova} funkcija, ki je
vrhove zožala, vmesnemu območju pa se je precej zmanjšala amplituda.
\begin{figure}[H]
    \centering
    \resizebox{0.49\linewidth}{!}{\input{graf5b.tex}}
    \resizebox{0.49\linewidth}{!}{\input{graf5a.tex}}
    \caption{Uporaba okenskih funkcij na obeh spektrih.}
    \label{slika5}
\end{figure}

\pagebreak

%----------------------------------------------------------------------------------------
%	PROBLEM 2
%----------------------------------------------------------------------------------------
\section{Wienerjev filter}
S~pomočjo Wienerjevega filtra naredimo dekonvolucijo signalov na datotekah 
\path{signal{0,1,2,3}.dat}. Število točk v~posameznem signalu je $512$. Na zadnjih treh 
datotekah je signalu primešan šum. Prenosna funkcija je
\begin{equation}
    r(t) = \frac{1}{2\tau} \mathrm{e}^{- |t|/\tau} \quad \tau=16.
\end{equation}
\subsection{Pristop}
Signal $u(t)$, ki prihaja v~merilno napravo s~prenosno funkcijo $r(t)$, se z~dodanim šumom
preoblikuje v:
\begin{equation}
    c(t) = (u*r)(t) + n(t) = s(t) + n(t),
\end{equation}
kjer je $s(t)$ izmerjen signal. Če šuma ni, lahko rekonstruiramo vhodni signal:
\begin{align}
    c(t) &= (u*r)(t) \quad 
    \xrightarrow{\mathcal{F}} \qquad 
    C(\omega) = U(\omega) \cdot R(\omega) \\
    U(\omega) &= \frac{C(\omega)}{R(\omega)} \qquad 
    \xrightarrow{\mathcal{F}^{-1}} \qquad 
    u(t) = \mathcal{F}^{-1}\left(\frac{C(\omega)}{R(\omega)}\right).
\end{align}
Ko dodamo šum moramo pred dekovolucijo transformiranko $C(\omega)$ pomnožiti z~Wienerjevim
filtrom:
\begin{equation}
    \Phi = \frac{|S(\omega)|^2}{|S(\omega)|^2 + |N(\omega)|^2},
\end{equation}
kjer sta $S(\omega)$ in $N(\omega)$ Fourierovi transformiranki $s(t)$ in $n(t)$.

\subsection{Reševanje in rezultati}
Na spodnjem grafu~\ref{slika6} so prikazani vsi štirje signali -- vidimo, da je prvi res
nezašumljen, ostali trije pa imajo precej šuma.
\begin{figure}[H]
    \centering
    \resizebox{0.49\linewidth}{!}{\input{graf6.tex}}
    \resizebox{0.49\linewidth}{!}{\input{graf10.tex}}
    \caption{Na levi je prikazan prvi signal -- $c_0$, na desni pa ostali trije signali.}
    \label{slika6}
\end{figure}
Zgoraj omenjeni postopek najprej uporabimo na nezašumljenem signalu \path{signal0} in 
poskusimo dobiti iz njega vhodni signal $u_0$. Na grafu~\ref{slika7} levo vidimo njegov
frekvenčni spekter, na desni pa rekonstruiran vstopni signal. Ta je sestavljen iz štirih
škatlastih signalov -- prvi je najvišji in najožji, ostali pa se nato nižajo in širijo.
\begin{figure}[H]
    \centering
    \resizebox{0.49\linewidth}{!}{\input{graf11.tex}}
    \resizebox{0.49\linewidth}{!}{\input{graf8.tex}}
    \caption{Frekvenčni spekter signala $c_0$ in dekonvuliran vstopni signal $u_0(t)$.}
    \label{slika7}
\end{figure}
Z~Wienerjevim filtrom rekonstruiramo še ostale signale in dobimo graf~\ref{slika8}. Moči
vsakega spektra so vedno višje, dobljen vhodni signal pa kljub uporabi filtra ni podoben
nezašumljenem signalu.
\begin{figure}[H]
    \centering
    \resizebox{0.49\linewidth}{!}{\input{graf7.tex}}
    \resizebox{0.49\linewidth}{!}{\input{graf9.tex}}
    \caption{Spektri in dekonvulirani vstopni signali.}
    \label{slika8}
\end{figure}
Filter $\Phi$ poskusimo izboljšati še tako, da območja, kjer se nam zdi, da dobimo samo
šum -- na začetku in koncu meritve -- postavimo na nič. Tako za različne širine teh 
intervalov (označene z$m$) pridelamo grafe~\ref{slika9}. Vidimo, da s~tem čistemu signalu
\emph{zaobljimo} obliko zmanjšamo amplitudo stopnic. Pri zašumljenih signalih vidimo,
da smo na tak način bolj ali manj uspešno rekonstruirali vstopni signal.
\begin{figure}[H]
    \centering
    \resizebox{0.49\linewidth}{!}{\input{graf12.tex}}
    \resizebox{0.49\linewidth}{!}{\input{graf13.tex}} \\
    \resizebox{0.49\linewidth}{!}{\input{graf14.tex}}
    \resizebox{0.49\linewidth}{!}{\input{graf15.tex}}
    \caption{Vstopni signali dobljeni z~rezanjem filtriranega območja -- $m$ je njihova 
    širina.}
    \label{slika9}
\end{figure}

%----------------------------------------------------------------------------------------
%	PROBLEM 3
%----------------------------------------------------------------------------------------
\section{Čiščenje slike}
V~arhivu \path{lena_slike.tar.gz} imamo slike podobe Lene, ki so razmazane s~tremi znanimi
konvolucijskimi jedri: tresoč objektiv (\path{kernel1.pgm}, slab fokus (\path{kernel2.pgm}
ter uklonska mrežica (\path{kernel3.pgm}). Datotekam je primešana različna količina
Gaussovega šuma (RMS $= 0,4,8,16$). Po filtriranju z~uporabo Wienerjevega filtra 
rekonstruiramo slike. V~arhivu so tudi slike z~dodano periodično motnjo (\path{*_nx.pgm}).
\subsection{Pristop}
Problema se lotimo na enak način kot v~prejšnjem odseku, le da tukaj Wienerjev filter
prepišemo v~drugo obliko:
\begin{equation}
    \Phi (\omega) = \frac{1}{R(\omega)} \frac{|R(\omega)|^2}{|R(\omega)|^2 + 
    \frac{N(\omega)}{S(\omega)}}
\end{equation}
Sliko po stolpcih preberemo in vsak posamezen stolpec, na enak način kot v~prejšnjem delu, 
rekonstruiramo. Zopet upoštevamo nek \emph{cut off} šuma in poskusimo očistiti sliko.
Slike brez dodanega gaussovega šuma lahko kar rekonstruiramo brez uporabe Wienerjevega 
filtra.
\subsection{Dobljene slike}
Najprej si poglejmo slike brez dodanega Gaussovega šuma:
\begin{figure}[H]
    \centering
    \includegraphics[width=0.3\textwidth]{3naloga/ociscena_lena_k1_n0.pdf}
    \includegraphics[width=0.3\textwidth]{3naloga/ociscena_lena_k2_n0.pdf}
    \includegraphics[width=0.3textwidth]{3naloga/ociscena_lena_k3_n0.pdf}
    \caption{Očiščene slike brez dodanega šuma -- od leve proti desni: 
    \protect\path{k1-n0}, \protect\path{k2-n0} in \protect\path{k3-n0}.}
    \label{slika10}
\end{figure}
vidimo, da je najlepše očiščena tretja slika, druga slika precej neprepoznavna, prva je 
sicer zatemnjena, vendar razločimo sliko. Poglejmo si najprej očiščene vse slike s~tretjim
jedrom.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.25\textwidth]{temp/ociscena-k3-n4.pdf}
    \includegraphics[width=0.25\textwidth]{temp/ociscena-k3-n8.pdf}\\
    \includegraphics[width=0.25\textwidth]{temp/ociscena-k3-n16.pdf}
    \includegraphics[width=0.25\textwidth]{temp/ociscena-k3-nx.pdf}
    \caption{Očiščene slike s~tretjim jedrom -- v~zgosnji vrsti: \protect\path{k3-n4}, 
    \protect\path{k3-n8} in v~spodnji: \protect\path{k3-n16} ter \protect\path{k3-nx}.}
    \label{slika11}
\end{figure}
Poskusimo očistiti tudi slike s~prvim jedrom, vendar že za najmanjši šum pride rešitev
precej zatemnjena in nerazpoznavna.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{temp/ociscena-k1-n4.pdf}
    \caption{Poskus čiščenja slike: \protect\path{k1-n4}}
    \label{slika12}
\end{figure}
Druge slike ne uspemo očistiti, poskusimo z~različnimi variacijami filtra in širinami 
frekvenčnih območij, ki jih odrežemo, morda bi morali poskusiti s~kakšnim drugačnim jedrom.
\end{document}
